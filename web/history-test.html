<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="viewport" content="initial-scale=1">
        <meta http-equiv="content-language" content="en">
        <meta name="language" content="en">
        <meta name="msapplication-config" content="none">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/simplex/bootstrap.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/patternomaly/1.3.2/patternomaly.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <style>
            body {
                background-color: rgb(255, 254, 250); 
            }
            .green {
                color: rgb(19, 63, 46); 
            }
            h2 {
                display: table;
                background-color: rgb(213, 227, 220); 
                color: rgb(19, 63, 46);
                font-size: 15px;
                padding: 6px;
                text-transform: uppercase;
                font-weight: bolder;
            }
            .container-fluid {
                max-width: 720px;
            }
            .chart-container {
                min-height: 400px;
                position: relative;
                margin-right: -15px;
                margin-left: -15px;
            }
            .space-after {
                padding-bottom: 25px;
            }
            a {
                font-family: inherit;
                text-decoration: underline;
                color: #6f6345;
            }
            a:hover, a:focus, a:active {
                color: #17476f;
            }
            .bold-num {
                font-weight: bolder;
                font-size: 40px;
            }
            .pos-tests-tbl {
                margin-bottom: 0;
                color: rgb(19, 63, 46);
            }
            .pos-tests-tbl th, .pos-tests-tbl td {
                vertical-align: middle;
                padding: 0 .3rem 0 .3rem;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid" style="background-color: rgb(246, 246, 240)" role="main">
            <!-- Intro -->
            <div class="row" style="margin-bottom: 15px; margin-top: 10px; background-color: rgb(255, 254, 250);">
                <div class="col">
                    <p>
                        <span id="updateDateTime" style="font-size: 16px; font-weight: 600; color: #666;">--</span><br>
                        Data updated Monday through Friday. Numbers reflect data from previous weekday.<br />
                        *Includes testing through Cal Poly Campus Health and Wellbeing and the university's ongoing testing program.<br />
                        <a id="history-toggle" href="#"></a>&nbsp;&nbsp;-&nbsp;&nbsp;<a id="download-link" href="">Download the data</a>
                    </p>
                </div>
            </div>
            <!--Test Results-->
            <div class="row">
                <div class="col-sm space-after">
                    <h2>Positive Student Tests</h2>
                    <table class="table table-borderless pos-tests-tbl">
                        <tbody>
                            <tr>
                                <td></td>
                                <th scope="col">On-Campus</th>
                                <th scope="col">Off-Campus</th>
                            </tr>
                            <tr>
                                <th scope="row">Total Since<br><span id="tp_sinceDate">--</span></th>
                                <td class="bold-num" id="tp_oncampus">--</td>
                                <td class="bold-num" id="tp_offcampus">--</td>
                            </tr>
                            <tr>
                                <th scope="row">Last 7 Days</th>
                                <td class="bold-num" id="tp7_oncampus">--</td>
                                <td class="bold-num" id="tp7_offcampus">--</td>
                            </tr>
                            <tr>
                                <th scope="row">Yesterday</th>
                                <td class="bold-num" id="tp_yesterdayon">--</td>
                                <td class="bold-num" id="tp_yesterdayoff">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-sm space-after">
                    <h2>Total Tests Since <span id="tp_startDate">--</span></h2>
                    <div class="row green">
                        <div class="col-6">
                            <span class="bold-num" id="ttsj4_total">--</span><br>Total
                        </div>
                        <div class="col-6">
                            <span class="bold-num" id="ttsj4_employee">--</span><br>Employees
                        </div>
                        <div class="col-6">
                            <span class="bold-num" id="ttsj4_onCampus">--</span><br>On-Campus Students
                        </div>
                        <div class="col-6">
                            <span class="bold-num" id="ttsj4_offCampus">--</span><br>Off-Campus Students
                        </div>
                    </div>
                </div>
            </div>
            <!--I/Q/QiP & Beds-->
            <div class="row">
                <div class="col-sm-7 space-after">
                    <h2>Isolation and Quarantine On Campus</h2>
                    <div class="row green">
                        <div class="col">
                            <span class="bold-num" id="qqip_isolation">0</span><br>Students in Isolation
                        </div>
                        <div class="col">
                            <span class="bold-num" id="qqip_selfQ">0</span><br>Students in Quarantine
                        </div>
                        <div class="col-5">
                            <span class="bold-num" id="qqip_qInPlace">0</span><br>Students in Quarantine In Place
                        </div>
                    </div>
                </div>
                <div class="col-sm-5 space-after">
                    <h2>Isolation/Quarantine Beds</h2>
                    <div class="row green">
                        <div class="col">
                            <span class="bold-num" id="iso_beds_occu">0</span><br>Beds Occupied
                        </div>
                        <div class="col">
                            <span class="bold-num" id="iso_beds_total">0</span><br>Total Beds
                        </div>
                    </div>
                </div>
            </div>
            <!--Graph: Daily Tests with 7-Day Avg Positivity Rate-->
            <div class="row space-after">
                <div class="col">
                    <h2>Daily Tests and Positive Cases with 7-Day Avg Positivity Rate</h2>
                    <div id="dailyTestPos">
                        <div class="chart-container">
                            <canvas role="img">Text alternative for this graph is in the data table below.</canvas>
                        </div>
                        <p><a class="toggle-data-table" href="#">Show/hide chart data table</a></p>
                        <div class="chart-data-table" style="display: none;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">7-day Avg Positivity</th>
                                        <th scope="col">Positive Tests</th>
                                        <th scope="col">Daily Tests</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!--Graph: New Student Cases-->
            <div class="row space-after">
                <div class="col">
                    <h2>New Student Cases</h2>
                    <div id="studentNewCases">
                        <div class="chart-container">
                            <canvas role="img">Text alternative for this graph is in the data table below.</canvas>
                        </div>
                        <p><a class="toggle-data-table" href="#">Show/hide chart data table</a></p>
                        <div class="chart-data-table" style="display: none;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">On-Campus Students</th>
                                        <th scope="col">Off-Campus Students</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!--Graph: Symptomatic vs Asymptomatic Cases-->
            <div class="row space-after">
                <div class="col">
                    <h2>Symptomatic vs Asymptomatic Cases</h2>
                    <div id="symptVsAsympt">
                        <div class="chart-container">
                            <canvas role="img">Text alternative for this graph is in the data table below.</canvas>
                        </div>
                        <p><a class="toggle-data-table" href="#">Show/hide chart data table</a></p>
                        <div class="chart-data-table" style="display: none;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">Symptomatic</th>
                                        <th scope="col">Asymptomatic</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!--Graph: 14-day Rolling-->
            <div class="row space-after">
                <div class="col">
                    <h2>14-day Rolling Percentage of Positive Cases Among Tests</h2>
                    <div id="rollingPosCases">
                        <div class="chart-container">
                            <canvas role="img">Text alternative for this graph is in the data table below.</canvas>
                        </div>
                        <p><a class="toggle-data-table" href="#">Show/hide chart data table</a></p>
                        <div class="chart-data-table" style="display: none;">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">Students</th>
                                        <th scope="col">Campus Employees</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            async function renderStats() {
                console.log(window.location.hash)
                if(window.location.hash == "#history") {
                    var url = "https://s3-us-west-2.amazonaws.com/coviddashboard.calpoly.io/stats-history.json";
                    $('#history-toggle').attr('href', '#').html('Hide historical data');
                }
                else {
                    var url = "https://s3-us-west-2.amazonaws.com/coviddashboard.calpoly.io/stats-test.json";
                    $('#history-toggle').attr('href', '#history').html('Show historical data');
                }

                $('#download-link').attr("href", url);

                const response = await fetch(url);
                const dataSource = await response.json();
                
                const dateString = moment(dataSource.updateDateTime).format("MMM DD, YYYY h:mm A");
                document.getElementById('updateDateTime').innerHTML = "Updated on " + dateString + ".";

                document.getElementById('tp_oncampus').innerHTML = dataSource.totalPositive.onCampusStu.toLocaleString();
                document.getElementById('tp_yesterdayon').innerHTML = dataSource.totalPositive.onCampusYesterday.toLocaleString();
                document.getElementById('tp_offcampus').innerHTML = dataSource.totalPositive.offCampusStu.toLocaleString();
                document.getElementById('tp_yesterdayoff').innerHTML = dataSource.totalPositive.offCampusYesterday.toLocaleString();

                document.getElementById('tp7_oncampus').innerHTML = dataSource.totalPositiveLast7.onCampus.toLocaleString();
                document.getElementById('tp7_offcampus').innerHTML = dataSource.totalPositiveLast7.offCampusInSlo.toLocaleString();

                document.getElementById('tp_sinceDate').innerHTML = moment(dataSource.startDate).format("MMM DD, YYYY");
                document.getElementById('tp_startDate').innerHTML = moment(dataSource.startDate).format("MMM DD, YYYY");

                document.getElementById('ttsj4_total').innerHTML = dataSource.testsSinceStart.total.toLocaleString();
                document.getElementById('ttsj4_onCampus').innerHTML = dataSource.testsSinceStart.onCampusStu.toLocaleString();
                document.getElementById('ttsj4_offCampus').innerHTML = dataSource.testsSinceStart.offCampusStu.toLocaleString();
                document.getElementById('ttsj4_employee').innerHTML = dataSource.testsSinceStart.employees.toLocaleString();
                
                document.getElementById('iso_beds_occu').innerHTML = dataSource.isoRoomsAvailable.occupied.toLocaleString();
                document.getElementById('iso_beds_total').innerHTML = dataSource.isoRoomsAvailable.total.toLocaleString();
                
                document.getElementById('qqip_selfQ').innerHTML = dataSource.quarantine.selfQuarantine.toLocaleString();
                document.getElementById('qqip_qInPlace').innerHTML = dataSource.quarantine.quarantineInPlace.toLocaleString();
                document.getElementById('qqip_isolation').innerHTML = dataSource.quarantine.isolation.toLocaleString();


                //Daily Tests and Positive Cases with 7-Day Avg Positivity Rate
                var dailyTestPos = $('#dailyTestPos');
                var tbody = dailyTestPos.find('.chart-data-table table tbody');
                tbody.empty();
                var data = dataSource.dailyTestPos;
                for(var i=0; i<data.dates.length; i++) {
                    var row = '<tr>';
                    row += '<th scope="row">'+data.dates[i]+'</th>';
                    row += '<td>'+data.avgPos7Day[i].toFixed(3).toLocaleString()+'</td>';
                    row += '<td>'+data.positiveTests[i].toLocaleString()+'</td>';
                    row += '<td>'+data.dailyTests[i].toLocaleString()+'</td>';
                    row += '</tr>';
                    tbody.append(row);
                }
                var mixedChart = new Chart(dailyTestPos.find('.chart-container canvas'), {
                    type: 'bar',
                    data: {
                        datasets: [{
                            type: 'line',
                            yAxisID: 'B',
                            label: '7-day Avg Positivity',
                            data: dataSource.dailyTestPos.avgPos7Day && dataSource.dailyTestPos.avgPos7Day.map((dataPt) => dataPt.toFixed(3)),
                            fill: false,
                            backgroundColor: 'rgb(19, 63, 46)',
                            borderColor: 'rgb(19, 63, 46)',
                            borderWidth: 2,
                            pointBorderWidth: 0.5

                        },{
                            type: 'bar',
                            yAxisID: 'A',
                            label: 'Positive Tests',
                            data: dataSource.dailyTestPos.positiveTests,
                            backgroundColor: 'rgb(191, 134, 32)'
                        },{
                            type: 'bar',
                            yAxisID: 'A',
                            label: 'Daily Tests',
                            data: dataSource.dailyTestPos.dailyTests,
                            backgroundColor: 'rgb(173, 198, 187)'
                        }],
                        labels: dataSource.dailyTestPos.dates
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            mode: 'index',
                            position: 'nearest'
                            },
                        legend: {
                            labels: {
                                padding: 15
                            }
                        }, 
                        scales: {
                            xAxes: [{
                                stacked: true,
                                gridLines: {
                                    display: false,
                                }
                            }],
                            yAxes: [{
                                id: 'A',
                                stacked: true,
                                position: 'left',
                                gridLines: {
                                    display: false,
                                },
                                scaleLabel: {
                                    display: true, 
                                    labelString: "Tests", 
                                    fontColor: "rgb(19, 63, 46)",
                                    fontStyle: "bold",
                                    fontSize: 16
                                }
                            }, {
                                id: 'B',
                                position: 'right',
                                gridLines: {
                                    display: false,
                                },
                                scaleLabel: {
                                    display: true, 
                                    labelString: "Percentage of positive tests", 
                                    fontColor: "rgb(19, 63, 46)",
                                    fontStyle: "bold",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });

                //New Student Cases
                var studentNewCases = $('#studentNewCases');
                var tbody = studentNewCases.find('.chart-data-table table tbody');
                tbody.empty();
                var data = dataSource.studentNewCases;
                for(var i=0; i<data.dates.length; i++) {
                    var row = '<tr>';
                    row += '<th scope="row">'+data.dates[i]+'</th>';
                    row += '<td>'+data.onCampusCases[i].toLocaleString()+'</td>';
                    row += '<td>'+data.offCampusCases[i].toLocaleString()+'</td>';
                    row += '</tr>';
                    tbody.append(row);
                }
                var mixedChart = new Chart(studentNewCases.find('.chart-container canvas'), {
                    type: 'bar',
                    data: {
                        datasets: [{
                            type: 'bar',
                            label: 'On-Campus Students',
                            data: dataSource.studentNewCases.onCampusCases,
                            backgroundColor: 'rgb(191, 134, 32)'
                        },{
                            type: 'bar',
                            label: 'Off-Campus Students',
                            data: dataSource.studentNewCases.offCampusCases,
                            backgroundColor: 'rgb(173, 198, 187)'
                        }],
                        labels: dataSource.studentNewCases.dates
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            mode: 'index',
                            position: 'nearest'
                        },
                        legend: {
                            labels: {
                                padding: 15
                            }
                        }, 
                        scales: {
                            xAxes: [{
                                stacked: true,
                                gridLines: {
                                    display: false,
                                }
                            }],
                            yAxes: [{
                                stacked: true,
                                gridLines: {
                                    display: false,
                                },
                                scaleLabel: {
                                    display: true, 
                                    labelString: "Positive cases", 
                                    fontColor: "rgb(19, 63, 46)",
                                    fontStyle: "bold",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });
                
                //Symptomatic vs Asymptomatic Cases
                var studentNewCases = $('#symptVsAsympt');
                var tbody = studentNewCases.find('.chart-data-table table tbody');
                tbody.empty();
                var data = dataSource.symptVsAsympt;
                for(var i=0; i<data.dates.length; i++) {
                    var row = '<tr>';
                    row += '<th scope="row">'+data.dates[i]+'</th>';
                    row += '<td>'+data.symptCases[i].toLocaleString()+'</td>';
                    row += '<td>'+data.asymptCases[i].toLocaleString()+'</td>';
                    row += '</tr>';
                    tbody.append(row);
                }
                var mixedChart = new Chart(studentNewCases.find('.chart-container canvas'), {
                    type: 'bar',
                    data: {
                        datasets: [{
                            type: 'bar',
                            label: 'Symptomatic',
                            data: dataSource.symptVsAsympt.symptCases,
                            backgroundColor: 'rgb(191, 134, 32)'
                        },{
                            type: 'bar',
                            label: 'Asymptomatic',
                            data: dataSource.symptVsAsympt.asymptCases,
                            backgroundColor: 'rgb(173, 198, 187)'
                        }],
                        labels: dataSource.symptVsAsympt.dates
                    },
                    options: {
                        maintainAspectRatio: false,
                            tooltips: {
                            mode: 'index',
                            position: 'nearest'
                        },
                        legend: {
                            labels: {
                                padding: 15
                            }
                        }, 
                        scales: {
                            xAxes: [{
                                stacked: true,
                                gridLines: {
                                    display: false,
                                }
                            }],
                            yAxes: [{
                                stacked: true,
                                gridLines: {
                                    display: false,
                                },
                                scaleLabel: {
                                    display: true, 
                                    labelString: "Positive cases", 
                                    fontColor: "rgb(19, 63, 46)",
                                    fontStyle: "bold",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });

                //14-day Rolling Percentage of Positive Cases Among Tests
                var rollingPosCases = $('#rollingPosCases');
                var tbody = rollingPosCases.find('.chart-data-table table tbody');
                tbody.empty();
                var data = dataSource.rollingPosCases;
                for(var i=0; i<data.dates.length; i++) {
                    var row = '<tr>';
                    row += '<th scope="row">'+data.dates[i]+'</th>';
                    row += '<td>'+data.students[i].toFixed(3).toLocaleString()+'</td>';
                    row += '<td>'+data.employees[i].toFixed(3).toLocaleString()+'</td>';
                    row += '</tr>';
                    tbody.append(row);
                }
                var mixedChart = new Chart(rollingPosCases.find('.chart-container canvas'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            type: 'line',
                            label: 'Students',
                            data: dataSource.rollingPosCases.students && dataSource.rollingPosCases.students.map((dataPt) => dataPt.toFixed(3)),
                            fill: false,
                            backgroundColor: 'rgb(191, 134, 32)',
                            borderColor: 'rgb(191, 134, 32)',
                            borderWidth: 2,
                            pointBorderWidth: 0.5
                        },
                        {
                            type: 'line',
                            label: 'Campus Employees',
                            data: dataSource.rollingPosCases.employees && dataSource.rollingPosCases.employees.map((dataPt) => dataPt.toFixed(3)),
                            fill: false,
                            backgroundColor: 'rgb(173, 198, 187)',
                            borderColor: 'rgb(173, 198, 187)',
                            borderWidth: 2,
                            pointBorderWidth: 0.5
                        }],
                        labels: dataSource.rollingPosCases.dates
                    },
                    options: {
                        maintainAspectRatio: false,
                        tooltips: {
                            mode: 'index',
                            position: 'nearest'
                        },
                        legend: {
                            labels: {
                                padding: 15
                            }
                        }, 
                        scales: {
                            xAxes: [{
                                gridLines: {
                                    display: false,
                                }
                            }],
                            yAxes: [{
                                gridLines: {
                                    display: false,
                                },
                                scaleLabel: {
                                    display: true, 
                                    labelString: "Percentage of positive tests", 
                                    fontColor: "rgb(19, 63, 46)",
                                    fontStyle: "bold",
                                    fontSize: 16
                                }
                            }]
                        }
                    }
                });
            }


            $(function() {
                renderStats();
                
                $('#history-toggle').click(function(e) {
                    console.log("e", e);
                    console.log("$(this)", $(this));

                    window.location.hash = $(this).attr('href');

                    e.preventDefault();
                    renderStats();
                });
                
                $(".toggle-data-table").click(function(e) {
                    e.preventDefault();
                    $(this).parent().siblings(".chart-data-table").toggle();
                });
            });
        </script>
    </body>
</html>